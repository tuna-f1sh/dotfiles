#!/bin/bash
set -e

if [ "$#" -ne 2 ]; then
    echo "Usage: create_can LINK BIT_RATE"
    exit 2
fi

link=$1
bitrate=$2

if [[ "$link" == vcan* ]]; then
  if $(sudo ip link show dev $link | grep -q 'does not exist'); then
    echo $link link already up
  else
    ip link add dev vcan0 type vcan
    ip link set up vcan0
  fi
else
  if $(sudo ip link show dev $link | grep -q 'DOWN'); then
    echo Creating "$link" link @ $bitrate b/s
    ip link set $link type can bitrate $bitrate restart-ms 100
    ip link set down $link
    ip link set up $link
  elif $(sudo ip link show dev $link | grep -q 'UP'); then
    echo $link link already up
  else
    echo Restarting CAN link $link
    # anything else bring it up and down
    ip link set down $link
    ip link set up $link
  fi
fi
